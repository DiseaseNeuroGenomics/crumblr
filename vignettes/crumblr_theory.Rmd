---
title: "crumblr: compare emprical and asymptotic theory"
subtitle: ''
author: "Developed by [Gabriel Hoffman](http://gabrielhoffman.github.io/)"
date: "Run on `r Sys.time()`"
documentclass: article
output: 
  html_document:
  toc: true
  smart: false
vignette: >
  %\VignetteIndexEntry{CTC}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\usepackage[utf8]{inputenc}
---



<!---
cd /Users/gabrielhoffman/workspace/repos/eval_methods/dreamlet
R

rmarkdown::render('crumblr_theory.Rmd')


cd /hpc/users/hoffmg01/work/eval_methods/dreamlet
R
# rm -rf test_ctc_cache
system("ml git; git pull")
rmarkdown::render("crumblr_theory.Rmd");


--->

```{r setup, echo=FALSE, results="hide"}
knitr::opts_chunk$set(	tidy=FALSE, 
												cache=TRUE,
												echo=FALSE,
                      	dev=c("png", "pdf"),
                      	package.startup.message = FALSE,
                      	message=FALSE, 
                      	error=FALSE, 
                      	warning=FALSE)

knitr::opts_chunk$set()

options(width=100)
```	

Let the vector ${\bf p}$ being the true fractions across $D$ categories.  With $n$ total counts sampled from a multinomial distribution, the [centered log ratio](https://rdrr.io/cran/compositions/man/clr.html) (CLR) of the observed counts ${\bf c}$ with estimated fractions ${\bf \hat p}$ is   
$$
\text{clr}_i({\bf \hat p}) = \log(\hat p_i) - \frac{1}{D}\sum_{j=1}^D \log(\hat p_j)
$$
 with sampling variance
$$
\text{var}[\text{clr}_i({\bf \hat p})] =  \frac{1}{n} \left[ \frac{1}{\hat p_i} - \frac{2}{ D \hat p_i} + \frac{1}{D^2}\sum_{j=1}^D \frac{1}{\hat p_j}  \right] 
$$

The sampling variance is derived from asymototic theory, so we examine its behavior for finite total counts, $n$.  Here we evalute the emprical variance from $100,000$ draws from a multinomial distribution while varying $n$ as well as the parameters of the distribution.  As pseudocount of 0.5 since the asymptotic theory is not defined for counts of zero.  The grey line indicates 2 counts, so for $n=30$ the line indicates $2/30=0.066$.  For the first case of $D=2$, the empirical and asymptotic variances are symmetric around $1/2$.  In the second case of $D=8$, the variances are no longer symmetric.

The asymptotic standard deviation shows remarkable agreement with the emprical results even for small values of $n$, *when at least 2 counts are observed*.  In practice, it is often reasonable to assume a sufficient number of counts before a variable is included in an analysis.  Importantly, with less than 2 counts the asymptotic theory gives a *larger* standard deviation than the emprical results.  Therefore, this approach is conservative and will not underestimate the true amount of variation.  


The asymptotic approximation is best for total counts > 30, and counts per cell > 7.  Need to add filter for cell types.  This is due to sum(1/p)

spped, fit into existing workflows for limma/dream/varianePartition/PCA


```{r define.fxn, cache=FALSE}
library(ggplot2)
library(crumblr)
library(gtools)
library(parallel)

rmultinomdir = function(n, size, alpha){

	p = rdirichlet(n, alpha)
	res = lapply( seq(1, n), function(i){
		rmultinom(1, size, prob=p[i,])
		})
	res = do.call(cbind, res)

	t(res)
} 

run_sim = function(other, pseudocount = .5){

	n_sims = 500
	j = 1

	# Some thoughts on counts in sequencing studies. NAR G&B
	# doi: 10.1093/nargab/lqaa094
	df_res = mclapply( c(100), function(countTotal){ # also 1000

		df_res = lapply( seq(0, countTotal - sum(other), by=.3), function(alpha_1){

			alpha_n1 = max(countTotal - alpha_1 - sum(other), 0)
			# alpha_n1 = countTotal - alpha_1

			# multinomial: counts are correlated
			alpha = c(alpha_1, alpha_n1, other)
			p = alpha / sum(alpha)
			c_mat = t(rmultinom(n_sims, countTotal, prob=p))

			x_clr = clr(c_mat + pseudocount)

			# sample mean
			mu_sample = colMeans(x_clr)

			# expected mean
			mu_expected = clr(p)

			# sample variance
			v_empirical = apply(x_clr, 2, var)

			# Multinomial-Dirichlet
			c_mat = rmultinomdir(n_sims, countTotal, alpha) 

			x_clr = clr(c_mat + pseudocount)
			mu_sample_md = colMeans(x_clr)
			v_empirical_md = apply(x_clr, 2, var)

			# expected variance
			D = ncol(c_mat)
			phat = (alpha + pseudocount) / sum(alpha + pseudocount)
			v_theoretical = (1/phat - 2/(phat*D) + sum(1/phat)/D^2) / countTotal
		
			data.frame(alpha_1, countTotal, 
								mu_sample = mu_sample[j],
								mu_expected = mu_expected[j],
								v_empirical = v_empirical[j],
								# mu_sample_md = mu_sample_md[j],
								v_empirical_md = v_empirical_md[j],
								v_theoretical = v_theoretical[j])
		})
		do.call(rbind, df_res)
	}, mc.cores=1)
	df_res = do.call(rbind, df_res)

	df_res
}
```


### 2 categories
```{r sim1, fig.width=10, fig.height=4}
df_res = run_sim(other=NULL)  

df_mu = reshape2::melt(df_res[,1:4], id.vars=c("alpha_1", "countTotal"))
df_v = reshape2::melt(df_res[,c(1:2, c(5:7))], id.vars=c("alpha_1", "countTotal"))

ymax = with(df_v, sqrt(max(value[variable =='v_empirical_md'])))

ggplot(df_v, aes(alpha_1 / countTotal, sqrt(value), color=variable, linetype=variable)) + geom_line() + theme_classic() + theme(aspect.ratio=1,plot.title = element_text(hjust = 0.5)) + facet_wrap(~countTotal, nrow=1) + xlab("fraction") + ylab("Standard Deviation") + geom_vline(aes(xintercept=2/countTotal), color="grey", linetype="dashed") + scale_color_manual(name="Method", values=c("blue4", "green4", "red"), labels=c( "Empirical (MN)", "Empirical (DMN)", "Asymptotic theory")) + scale_linetype_manual(name="Method", labels=c("Empirical (MN)", "Empirical (DMN)", "Asymptotic theory"), values=c(1, 1, 2)) + ggtitle("Compare empirical and asymptotic standard deviations") + xlab("Fraction") + coord_fixed(ylim=c(0, ymax*1.05)) 
```

```{r exit, cache=FALSE, eval=FALSE}
knitr::knit_exit()
```

### 8 categories
```{r sim2, fig.width=10, fig.height=4}
other = rep(8:12)
df_res = run_sim(other=other)

df_mu = reshape2::melt(df_res[,1:4], id.vars=c("alpha_1", "countTotal"))
df_v = reshape2::melt(df_res[,c(1:2, c(5:7))], id.vars=c("alpha_1", "countTotal"))

ymax = with(df_v, sqrt(max(value[variable =='v_empirical_md'])))

ggplot(df_v, aes(alpha_1 / countTotal, sqrt(value), color=variable, linetype=variable)) + geom_line() + theme_classic() + theme(aspect.ratio=1,plot.title = element_text(hjust = 0.5)) + facet_wrap(~countTotal, nrow=1) + xlab("fraction") + ylab("Standard Deviation") + geom_vline(aes(xintercept=2/countTotal), color="grey", linetype="dashed") + scale_color_manual(name="Method", values=c("blue4", "green4", "red"), labels=c( "Empirical (MN)", "Empirical (DMN)", "Asymptotic theory")) + scale_linetype_manual(name="Method", labels=c("Empirical (MN)", "Empirical (DMN)", "Asymptotic theory"), values=c(1, 1, 2)) + ggtitle("Compare empirical and asymptotic standard deviations") + xlab("Fraction") + coord_fixed(ylim=c(0, ymax*1.05)) 
```
















```{r test, eval=FALSE}
library(compositions)

x = c(1,2,3, 6)
V = ilrBase(D = length(x))

crossprod(V, clr(x))
ilr(x)

V %*% ilr(x)
clr(x)

ginv(V) - t(V)


# variance from multinomial
# diag(diag(p) - tcrossprod(p)) / countTotal
# rowVars(apply(c_mat, 1, function(x) x/sum(x)))

# # variance from ilr using delta method
# library(compositions)
# library(matrixStats)
# V = ilrBase(D=ncol(c_mat))
# head(ilr(c_mat))
# head(clr(c_mat) %*% V)

# colVars(ilr(c_mat))
# diag((crossprod(V, diag(1/p)) %*% V) / countTotal)


# One = rep(1, D)
# I = diag(1,D)
# C = (I-tcrossprod(One)/ D) %*% diag(1/p) %*% (I-tcrossprod(One)/ D) / countTotal
# diag(C)


```
